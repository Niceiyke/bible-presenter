name: Build Windows Exe
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: install rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: install frontend dependencies
        run: |
          cd desktop-rs
          npm install

      - name: download models and bible data
        shell: bash
        run: |
          set -e
          mkdir -p desktop-rs/src-tauri/models
          mkdir -p desktop-rs/src-tauri/bible_data

          # ── AI models (public HuggingFace) ────────────────────────────────
          echo "Downloading ONNX embedding model..."
          curl -L "https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/onnx/model.onnx" \
            -o "desktop-rs/src-tauri/models/all-minilm-l6-v2.onnx"

          echo "Downloading Whisper base model..."
          curl -L "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin" \
            -o "desktop-rs/src-tauri/models/whisper-base.bin"

          # ── Bible database (public repo) ────────────────────────────────
          echo "Downloading super_bible.db (~59 MB)..."
          curl -L "https://raw.githubusercontent.com/alshival/super_bible/main/SUPER_BIBLE/super_bible.db" \
            -o "desktop-rs/src-tauri/bible_data/super_bible.db"

          # ── Stacked embeddings (Google Drive) ──────────────────────────
          echo "Downloading all_versions_embeddings.npy from Google Drive..."
          pip install -q gdown
          gdown "https://drive.google.com/uc?id=18rQG5jnZQoM2v1l2EV71VWyTp38lEe5f" \
            -O "desktop-rs/src-tauri/bible_data/all_versions_embeddings.npy"

          # ── verse_index.json (committed in repo) ────────────────────────
          if [ -f "desktop-rs/src-tauri/bible_data/verse_index.json" ]; then
            echo "verse_index.json found in repo."
          else
            echo "CRITICAL: verse_index.json missing! Commit it to the repo first."
            exit 1
          fi

          # ── Verify all required files ───────────────────────────────────
          echo "Verifying files..."
          ls -lh desktop-rs/src-tauri/models/
          ls -lh desktop-rs/src-tauri/bible_data/

          for f in \
            "desktop-rs/src-tauri/models/all-minilm-l6-v2.onnx" \
            "desktop-rs/src-tauri/models/whisper-base.bin" \
            "desktop-rs/src-tauri/models/tokenizer.json" \
            "desktop-rs/src-tauri/bible_data/super_bible.db" \
            "desktop-rs/src-tauri/bible_data/all_versions_embeddings.npy" \
            "desktop-rs/src-tauri/bible_data/verse_index.json"; do
            if [ ! -f "$f" ]; then
              echo "CRITICAL: $f missing!"
              exit 1
            fi
            echo "OK: $f ($(du -h "$f" | cut -f1))"
          done

      - name: install numpy for validation
        run: pip install -q numpy

      - name: validate embeddings file
        shell: python
        run: |
          import numpy as np, sys
          path = 'desktop-rs/src-tauri/bible_data/all_versions_embeddings.npy'

          # 1. Magic bytes — a Google Drive error page would fail here
          with open(path, 'rb') as f:
              magic = f.read(6)
          if magic != b'\x93NUMPY':
              print('CRITICAL: Not a valid .npy file. Magic bytes: ' + repr(magic))
              print('This usually means Google Drive returned an HTML error page.')
              sys.exit(1)
          print('Magic bytes OK: ' + repr(magic))

          # 2. Shape and dtype
          arr = np.load(path)
          print('Shape : ' + str(arr.shape))
          print('Dtype : ' + str(arr.dtype))

          if arr.ndim != 2:
              print('CRITICAL: Expected 2-D array, got ' + str(arr.ndim) + '-D')
              sys.exit(1)
          if arr.shape[1] != 384:
              print('CRITICAL: Expected 384 embedding dims, got ' + str(arr.shape[1]))
              sys.exit(1)
          if arr.dtype != np.float32:
              print('CRITICAL: Expected float32 dtype, got ' + str(arr.dtype))
              sys.exit(1)
          if arr.shape[0] < 1000:
              print('CRITICAL: Only ' + str(arr.shape[0]) + ' rows - download likely truncated')
              sys.exit(1)

          print('PASSED: ' + str(arr.shape[0]) + ' verse vectors x 384 dims, dtype=float32')

      - name: build and publish release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          RUSTFLAGS: "-C target-feature=-crt-static"
          MSVC_RUNTIME_LIBRARY: "MultiThreadedDLL"
          VCPKG_DEFAULT_TRIPLET: "x64-windows"
          CFLAGS: "/MD"
          CXXFLAGS: "/MD"
          CMAKE_MSVC_RUNTIME_LIBRARY: "MultiThreadedDLL"
        with:
          projectPath: desktop-rs
          tagName: v__VERSION__
          releaseName: "Bible Presenter v__VERSION__"
          releaseBody: "See the assets below to download this version."
          releaseDraft: false
          prerelease: false
